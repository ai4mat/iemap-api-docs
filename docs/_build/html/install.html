<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to install &mdash; IEMAP API 1.1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="How to use IEMAP API" href="apiuser.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> IEMAP API
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">For Users:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apiuser.html">How to use IEMAP API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For Developers:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to install</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#get-the-code">Get the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#make-some-configurations">Make some configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-on-local-machine">Run on local machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-as-container">Run as container</a></li>
<li class="toctree-l2"><a class="reference internal" href="#check-api">Check API</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">IEMAP API</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>How to install</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/install.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-install">
<h1>How to install<a class="headerlink" href="#how-to-install" title="Permalink to this heading"></a></h1>
<section id="get-the-code">
<h2>Get the code<a class="headerlink" href="#get-the-code" title="Permalink to this heading"></a></h2>
<p>First of all you need to get the code:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/ai4mat/mi-api.git
</pre></div>
</div>
<p>and jump to its folder:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> mi-api
</pre></div>
</div>
</section>
<section id="make-some-configurations">
<h2>Make some configurations<a class="headerlink" href="#make-some-configurations" title="Permalink to this heading"></a></h2>
<p>You first need to setup configurations into the environments file. Copy the <code class="code docutils literal notranslate"><span class="pre">env.sample</span></code> into <code class="code docutils literal notranslate"><span class="pre">.env</span></code> and edit this file for each variable.</p>
</section>
<section id="run-on-local-machine">
<h2>Run on local machine<a class="headerlink" href="#run-on-local-machine" title="Permalink to this heading"></a></h2>
<ul>
<li><dl>
<dt>1 - Export the variables</dt><dd><p>First of all you need to export variables into the environment with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="k">$(</span>xargs &lt; .env<span class="k">)</span>
</pre></div>
</div>
<p>After that you need to create the python environment. You can choose to use <code class="code docutils literal notranslate"><span class="pre">pip</span></code> or <code class="code docutils literal notranslate"><span class="pre">poetry</span></code>.</p>
</dd>
</dl>
</li>
<li><dl>
<dt>2a - Setup python environment with pip</dt><dd><p>Create the virtualenv (assuming you have python 3.X) and activate it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 -m venv &lt;your-virtual-env&gt;
<span class="nb">source</span> &lt;your-virtual-env&gt;/bin/activate
</pre></div>
</div>
<p>Then install requirements:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install -r requirements
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>2b - Setup python environment with poetry</dt><dd><p>Install <code class="code docutils literal notranslate"><span class="pre">poetry</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -sSL https://install.python-poetry.org <span class="p">|</span> python3 -
</pre></div>
</div>
<p>Run the following commands to bootstrap your environment with <code class="code docutils literal notranslate"><span class="pre">poetry</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>poetry install
poetry shell
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>3 - Run the server</dt><dd><p>Now you’re ready to start the API just with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> app/
uvicorn main:app --reload
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</section>
<section id="run-as-container">
<h2>Run as container<a class="headerlink" href="#run-as-container" title="Permalink to this heading"></a></h2>
<ul>
<li><dl>
<dt>0 - Prerequisites</dt><dd><p>In the following we are assuming that you can manage docker with a non-root user. To do so, run the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo groupadd docker
sudo usermod -aG docker <span class="nv">$USER</span>
</pre></div>
</div>
<p>You had created the <code class="code docutils literal notranslate"><span class="pre">docker</span></code> group first and then added your user to it. This way now you can build, run and stop containers with your user, without worrying about <code class="code docutils literal notranslate"><span class="pre">sudo</span></code>.</p>
</dd>
</dl>
</li>
<li><dl>
<dt>1 - Configuration</dt><dd><p>Add this to your server <code class="code docutils literal notranslate"><span class="pre">.bashrc</span></code> or <code class="code docutils literal notranslate"><span class="pre">.profile</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">HOST_FILESDIR</span><span class="o">=</span>&lt;absoloute path where uploaded files are stored on host&gt;
<span class="nb">export</span> <span class="nv">FILESDIR</span><span class="o">=</span>&lt;path where files are stored inside the container&gt;
</pre></div>
</div>
<p>to set this variable both inside and outside container.</p>
</dd>
</dl>
</li>
<li><dl>
<dt>2 - Build image and run container</dt><dd><p>Run the following command to build the image and run the container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make all
</pre></div>
</div>
<p>You can also run multiple containers from the same builded image. You need to build first and then run each container on different port. To do so, run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make build
</pre></div>
</div>
<p>And then run each container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nv">HOST_PORT</span><span class="o">=</span>&lt;port&gt; run
</pre></div>
</div>
<p>In the following a complete list of commands defined into the <code class="code docutils literal notranslate"><span class="pre">Makefile</span></code>, to simplify container managment:</p>
<table class="colwidths-given docutils align-default" id="id1">
<caption><span class="caption-text">Commands defined into the Makefile</span><a class="headerlink" href="#id1" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 67%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Action</p></th>
<th class="head"><p><code class="code docutils literal notranslate"><span class="pre">command</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Build and run</p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Build image</p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">build</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Run container</p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">run</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Stop container</p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">stop</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Start container</p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">start</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Kill (stop &amp; remove container)</p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">kill</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Clean (remove eventually dead containers and remove images)</p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code></p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To get the list of running containers (with their IDs), run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker ps
</pre></div>
</div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>3 - Configure NGINX as reverse proxy</dt><dd><p>Create a new virtual host in your <code class="code docutils literal notranslate"><span class="pre">/etc/nginx/sites-available</span></code> folder and add the following configuration (supposing you are running with SSL/TLS encryption):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>server <span class="o">{</span>
    listen <span class="m">80</span><span class="p">;</span>
    server_name &lt;your-domain-name&gt;<span class="p">;</span>
    <span class="k">return</span> <span class="m">301</span> https://<span class="nv">$server_name$request_uri</span><span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>
    listen <span class="m">443</span> ssl<span class="p">;</span>
    server_name &lt;your-domain-name&gt;<span class="p">;</span>

    ssl_certificate /etc/letsencrypt/live/&lt;your-domain-name&gt;/fullchain.pem<span class="p">;</span>
    ssl_certificate_key /etc/letsencrypt/live/&lt;your-domain-name&gt;/privkey.pem<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://127.0.0.1:8000<span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header X-NginX-Proxy true<span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
        proxy_pass_request_headers on<span class="p">;</span>
        proxy_http_version <span class="m">1</span>.1<span class="p">;</span>
        proxy_set_header Upgrade <span class="nv">$http_upgrade</span><span class="p">;</span>
        proxy_set_header Connection <span class="s2">&quot;upgrade&quot;</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>3 Bis - Configure NGINX as load balancer</dt><dd><p>If you’re running multiple containers on the same server, you can configure NGINX as load balancer. To do so, you need to create a new virtual host in your <code class="code docutils literal notranslate"><span class="pre">/etc/nginx/sites-available</span></code> folder and add the following configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>upstream backend <span class="o">{</span>
    least_conn<span class="p">;</span>
    server <span class="m">127</span>.0.0.1:&lt;port1&gt;<span class="p">;</span>
    server <span class="m">127</span>.0.0.1:&lt;port2&gt;<span class="p">;</span>
    ...
<span class="o">}</span>

server <span class="o">{</span>
    listen <span class="m">80</span><span class="p">;</span>
    server_name &lt;your-domain-name&gt;<span class="p">;</span>
    <span class="k">return</span> <span class="m">301</span> https://<span class="nv">$server_name$request_uri</span><span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>
    listen <span class="m">443</span> ssl<span class="p">;</span>
    server_name &lt;your-domain-name&gt;<span class="p">;</span>

    ssl_certificate /etc/letsencrypt/live/&lt;your-domain-name&gt;/fullchain.pem<span class="p">;</span>
    ssl_certificate_key /etc/letsencrypt/live/&lt;your-domain-name&gt;/privkey.pem<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://backend<span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header X-NginX-Proxy true<span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
        proxy_pass_request_headers on<span class="p">;</span>
        proxy_http_version <span class="m">1</span>.1<span class="p">;</span>
        proxy_set_header Upgrade <span class="nv">$http_upgrade</span><span class="p">;</span>
        proxy_set_header Connection <span class="s2">&quot;upgrade&quot;</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We have configured the load balancer with the <em>Least connections</em> algorithm. This means that the server with the least connections will be used. If you want to use the <em>Round-Robin</em> algorithm, you can change the <code class="code docutils literal notranslate"><span class="pre">least_conn</span></code> in the <code class="code docutils literal notranslate"><span class="pre">upstream</span></code> definition to <code class="code docutils literal notranslate"><span class="pre">round_robin</span></code>.</p>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>4 - Check and restart NGINX</dt><dd><p>Check the configuration and activate the new virtual host:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nginx -t
</pre></div>
</div>
<p>If the check is ok, then create the symbolic link into the <code class="code docutils literal notranslate"><span class="pre">/etc/nginx/sites-enabled</span></code> folder:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ln -s /etc/nginx/sites-available/&lt;your-vhost-name&gt; /etc/nginx/sites-enabled/&lt;your-vhost-name&gt;
</pre></div>
</div>
<p>Then reload the web server configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nginx -s reload
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</section>
<section id="check-api">
<h2>Check API<a class="headerlink" href="#check-api" title="Permalink to this heading"></a></h2>
<ul>
<li><dl>
<dt>1a - Check if the API is running locally</dt><dd><p>To check if the API is running locally, run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -i http://localhost:8000
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>1b - Check if the API is running on the server (with SSL/TLS encryption)</dt><dd><p>To check if the API is running on the server, run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -i https://&lt;your-domain-name&gt;
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>2 - Expected behavior</dt><dd><p>If all is working properly, you’ll get this output:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;request_method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;path_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Reply from IEMAP API at &lt;current time and date&gt;&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="apiuser.html" class="btn btn-neutral float-left" title="How to use IEMAP API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, ENEA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>